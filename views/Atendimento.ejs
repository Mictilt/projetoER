<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UMa Farmácia</title>
    <%- include('./partials/Style')%>
    <%- include('./partials/Style_Atendimento')%>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<script type="module">
    import 'https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js'
    import insertText from 'https://cdn.jsdelivr.net/npm/insert-text-at-cursor@0.3.0/index.js'

    document.querySelector('emoji-picker').addEventListener('emoji-click', e => {
        insertText(document.querySelector('input'), e.detail.unicode)
    })
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
    <script>
        let nMsg = 0;
        function intToRGB(i) {
            var c = (i & 0x00FFFFFF)
                .toString(16)
                .toUpperCase();

            return "00000".substring(0, 6 - c.length) + c;
        }

        function hashCode(str) { // java String#hashCode
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            var result = intToRGB(hash);
            console.log(result);
            return result;
        }
        function incrementa(){
            nMsg = nMsg + 1
        }
        $(document).ready(function () {
            var socket = io();
            <% if (!isAuthenticated){ %>
            $("#join").click(function () {
                var name = $("#name").val();
                if (name != "") {
                    socket.emit("join", name);
                    alert("Login successful!!");
                    $("#login").remove();
                }else{
                    alert("Please insert a valid user name");
                }
            });


            $('form').submit(function () {
                socket.emit('chat message', $('#m').val());
                console.log($('#m').val());
                $('#m').val('');
                return false;
            });
            socket.on('chat message', function (msg) {
                let nomeMsg = String(msg.id);
                $('#messages').append('<li id="'+nMsg+'"  style=background-color:#' + hashCode(msg.id) + '> <button value="Editar" onclick="editar('+nMsg+')">Editar</button> <button value="Apagar" onclick="apagar('+nMsg+')">Apagar</button> <a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button" aria-controls="offcanvasExample">Criar Ticket</a> <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel"> <div class="offcanvas-header"> <h5 class="offcanvas-title labelAten">Criar Ticket</h5> <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body"> <div class="labelAten"><form action = "/tickets/criarTicket" method="post"><div class="labelAten">Email: <input type="text" name="email"></div><div class="labelAten">Título: <input type="text" name="title"></div><input type="hidden" name="description" value="'+msg.msg+'"><input type="hidden" name="User" value=""> <button type="submit" value="Submit">Criar Ticket</button></form></div> <div> </div> /div> </div><input hidden id ="nomeMsg" value="'+nomeMsg+'"> </li>');
                incrementa();
                $('#messages').append('<li id="'+nMsg+'"  style=background-color:#' + hashCode(msg.id) + '>'+ ( msg.id+ ":" + msg.msg) +' </li>');
                incrementa();
                window.scrollTo(0,document.body.scrollHeight);
            });
            socket.on('update',function(msg){
                $('#messages').append('<li style="background-color:#000000;color:#FFFFFF">' + (msg) + '</li>');
                window.scrollTo(0,document.body.scrollHeight);
            });

                    <%} else{%>


            //We don't need to pass the name, it will be obtained from the session
            socket.emit("join");

            $('form').submit(function () {
                socket.emit('chat message', $('#m').val());
                console.log($('#m').val());
                $('#m').val('');
                return false;
            });
            socket.on('chat message', function (msg) {
                let nomeMsg = String(msg.id);
                $('#messages').append('<li id="'+nMsg+'" style=background-color:#' + hashCode(msg.id) + '> <button  value="Editar" onclick="editar('+nMsg+')">Editar</button> <button onclick="apagar('+nMsg+')"  value="Apagar">Apagar</button><a class="btn btn-primary" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button" aria-controls="offcanvasExample">Criar Ticket</a> <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel"> <div class="offcanvas-header"> <h5 class="offcanvas-title labelAten">Criar Ticket</h5> <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body"> <div class="labelAten"><form action = "/tickets/criarTicket" method="post"><div class="labelAten">Email: <input type="text" name="email"></div><div class="labelAten">Título: <input type="text" name="title"></div><input type="hidden" name="description" value="'+msg.msg+'"><input type="hidden" name="User" value=""> <button type="submit" value="Submit">Criar Ticket</button></form></div> <div> </div> </div> </div><input hidden id ="nomeMsg" value="'+nomeMsg+'"><button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Criar FAQ</button> <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"> <div class="offcanvas-header labelAten"> <h5 id="offcanvasRightLabel">Criar FAQ</h5> <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body labelAten"><form action="/faq/create" method="post">Pergunta: <input name ="question" type="text"> <input type="hidden" name="answer" value="'+msg.msg+'"> <input type="hidden" name="topic" value="questaogeral"> <input type="hidden" name="User" value="<%=User.id%>"><input type ="hidden" name= "pinned" value = "false"><button type="submit" value="Submit">Criar FAQ</button></form> </div> </div><input hidden id ="nomeMsg" value="'+nomeMsg+'"> </li>');
                incrementa();
                $('#messages').append('<li id="'+nMsg+'" style=background-color:#' + hashCode(msg.id) + '>'+ ( msg.id+ ":" + msg.msg) + '</li>');
                incrementa();
                window.scrollTo(0,document.body.scrollHeight);
            });

            socket.on('update',function(msg){
                $('#messages').append('<li style="background-color:#000000;color:#FFFFFF">' + (msg) + '</li>');
                window.scrollTo(0,document.body.scrollHeight);
            });
                    <%} %>
        });
    </script>
<body>
<% if (isAuthenticated){ %>
    <%- include('./partials/Base_Logged')%>
<%} else{%>
    <%-include('./partials/Base_Notlogged')%>
<%} %>
<main>
    <% if (!isAuthenticated){ %>
    <div id="login">
        <form  id="login_form">
            <label class="labelAten">Introduza o seu nome para o chat: </label>
            <input type="text" placeholder="Your name" id="name">
            <input type="button" name="join" id="join" value="Join">
        </form>
    </div>
        <%} %>
    <div class = "align-middle">
        <div class = "row">
            <label class="labelAten centrado">Número de agentes logados: <span><%=numAgentes%></span></label>
        </div>
    </div>
    <div class="row">
        <div class="col">
          <label class="labelAten"> Chat: </label>
            <% if (isAuthenticated){ %>
            <div class="mens_Pre">
                <label class="labelAten"> Respostas Pré-feitas: </label>
            <select name="responses" id="mensPre">
                <% user.forEach(function(user) { %>
                <%if(user._id == User.id ){%>
                <option value = "<%=user.responses%>"><%=user.responses%></option>
                <%}%>
                <% });%>
            </select>
            <button onclick="passar()">Enviar</button>
            </div>
            <%} %>
        </div>
        <div class="col-6">
            <div id="chat">
                <ul id="messages"></ul>
            </div>
            <hr>
            <form id="message_form" action="">
                <input style="width:90%" id="m"  autocomplete="off" />
                <div class="buttonChat">
                    <button>Send Message</button>
                </div>
                <emoji-picker class="light"></emoji-picker>
            </form>
        </div>
        <div class="col">
            <div class = "row">
                <a href="/faq" target="_blank"><button>Consultar FAQ</button></a>
            </div>
        </div>
      </div>
</main>
<script>
    function apagar(id){
        let vazio = null;
        document.getElementById(id).innerHTML = vazio;
        document.getElementById(id+1).innerHTML = vazio;
    }
    function editar(id){
        let novaM = $('#m').val();
        let nome = $('#nomeMsg').val();
        let valor = (nome + ":" + novaM);
        document.getElementById(id+1).innerHTML = valor;
        $('#m').val("");
    }
    function passar() {
        let mens = $('#mensPre').val();
        $('#m').val(mens);
    }
    document.querySelector('emoji-picker')
        .addEventListener('emoji-click', event => console.log(event.detail));
</script>
<%-include('./partials/Footer')%>
</body>
</html>